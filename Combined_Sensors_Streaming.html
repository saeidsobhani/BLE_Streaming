<html>
 <head>
  <title>Bangle.js Combined Sensors Streaming</title>
 </head>
 <body>

<script src="https://www.puck-js.com/puck.js"></script>
<button id="btnConnect">Connect</button>
<h3>Accelerometer</h3>
<p>X: <span class="bar"><span id="barAccelX"></span></span> <span id="valueAccelX">0</span></p>
<p>Y: <span class="bar"><span id="barAccelY"></span></span> <span id="valueAccelY">0</span></p>
<p>Z: <span class="bar"><span id="barAccelZ"></span></span> <span id="valueAccelZ">0</span></p>

<h3>Magnetometer</h3>
<p>X: <span class="bar"><span id="barMagX"></span></span> <span id="valueMagX">0</span></p>
<p>Y: <span class="bar"><span id="barMagY"></span></span> <span id="valueMagY">0</span></p>
<p>Z: <span class="bar"><span id="barMagZ"></span></span> <span id="valueMagZ">0</span></p>

<p><strong>Data Rate: <span id="dataRate">0</span> Hz</strong></p>

<script>
// Code to upload to Bangle.js (BLE service version)
var BANGLE_CODE = `
// upload this to the Bangle

var batteryInterval, connected = false;

function onMag(d) {
  if (connected) {
    NRF.updateServices({
      'f8b23a4d-89ad-4220-8c9f-d81756009f0c': {
        'f8b23a4d-89ad-4220-8c9f-d81756009f0c': {
          value: new Int32Array([d.x, d.y, d.z]).buffer,
          notify: true
        }
      }
    })
  }
}

function onAccel(d) {
  if (connected) {
    NRF.updateServices({
      'f8b23a4d-89ad-4220-8c9f-d81756009f0c': {
        'f8b23a4d-89ad-4220-8c9f-d81756009f0d': {
          value: new Float32Array([d.x, d.y, d.z]).buffer,
          notify: true
        }
      }
    })
  }
}

function onInit() {
  // on connect / disconnect blink the green / red LED turn on / off the magnetometer
  NRF.on('connect', function () { connected = true; Bangle.setCompassPower(1); Bangle.setPollInterval(10); Bangle.compassWr(0x31, 0x08); })
  NRF.on('disconnect', function () { connected = false; Bangle.setCompassPower(0); })

  // declare the services
  NRF.setServices({
    // Magneto&accelerometer service
    'f8b23a4d-89ad-4220-8c9f-d81756009f0c': {
      'f8b23a4d-89ad-4220-8c9f-d81756009f0c': {
        description: 'Bangle magnetometer',
        notify: true,
        readable: true,
        value: new Int32Array([0, 0, 0]).buffer,
        writable: true,
        onWrite: function (evt) {
          var d = evt.data && evt.data[0]
          if ([80, 40, 20, 10, 5].indexOf(d) >= 0) { Bangle.setPollInterval(1000 / d) }
        }
      },
      'f8b23a4d-89ad-4220-8c9f-d81756009f0d': {
        description: 'Bangle accelerometer',
        notify: true,
        readable: true,
        value: new Float32Array([0, 0, 0]).buffer
      }
    }
  })

  Bangle.on('accel', onAccel)
  Bangle.on('mag', onMag)
}
`;

// Variables for calculating Messages/Second (Hz)
var messagesThisSecond = 0;
var dataRateTimer = null;
var accelChar, magChar;

document.getElementById("btnConnect").addEventListener("click", function() {
  // First, upload the code to the Bangle via serial
  Puck.connect(function(c) {
    if (!c) {
      alert("Couldn't connect!");
      return;
    }
    c.write("reset();\n", function() {
      setTimeout(function() {
        c.write("\x03\x10if(1){"+BANGLE_CODE+"}\n", function() {
          console.log("Code uploaded. Now connect via BLE.");
          c.close();
          // Now connect via Web Bluetooth
          connectBLE();
        });
      }, 1500);
    });
  });
});

async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'Bangle.js' }],
      optionalServices: ['f8b23a4d-89ad-4220-8c9f-d81756009f0c']
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('f8b23a4d-89ad-4220-8c9f-d81756009f0c');
    
    accelChar = await service.getCharacteristic('f8b23a4d-89ad-4220-8c9f-d81756009f0d');
    magChar = await service.getCharacteristic('f8b23a4d-89ad-4220-8c9f-d81756009f0c');
    
    await accelChar.startNotifications();
    await magChar.startNotifications();
    
    accelChar.addEventListener('characteristicvaluechanged', handleAccel);
    magChar.addEventListener('characteristicvaluechanged', handleMag);
    
    // Start data rate timer
    dataRateTimer = setInterval(function() {
      document.getElementById("dataRate").textContent = messagesThisSecond;
      messagesThisSecond = 0;
    }, 1000);
    
    console.log("Connected via BLE");
  } catch (error) {
    console.error('BLE connection failed:', error);
  }
}

function handleAccel(event) {
  const data = new Float32Array(event.target.value.buffer);
  const accel = { x: data[0], y: data[1], z: data[2] };
  
  setBarPos("barAccelX", accel.x, 2);
  setBarPos("barAccelY", accel.y, 2);
  setBarPos("barAccelZ", accel.z, 2);
  
  document.getElementById("valueAccelX").textContent = accel.x.toFixed(2);
  document.getElementById("valueAccelY").textContent = accel.y.toFixed(2);
  document.getElementById("valueAccelZ").textContent = accel.z.toFixed(2);
  
  messagesThisSecond++;
}

function handleMag(event) {
  const data = new Int32Array(event.target.value.buffer);
  const mag = { x: data[0], y: data[1], z: data[2] };
  
  setBarPos("barMagX", mag.x, 10000);
  setBarPos("barMagY", mag.y, 10000);
  setBarPos("barMagZ", mag.z, 10000);
  
  document.getElementById("valueMagX").textContent = mag.x;
  document.getElementById("valueMagY").textContent = mag.y;
  document.getElementById("valueMagZ").textContent = mag.z;
  
  messagesThisSecond++;
}

// Set the position of each bar
function setBarPos(id, d, scale) {
  var s = document.getElementById(id).style;
  // Scale values
  var scaledValue = (d / scale) * 150;
  
  // Clamp values to bar limits
  if (scaledValue > 150) scaledValue = 150;
  if (scaledValue < -150) scaledValue = -150;
  
  if (scaledValue >= 0) {
    s.left = "150px";
    s.width = scaledValue + "px";
  } else {
    s.left = (150 + scaledValue) + "px";
    s.width = (-scaledValue) + "px";
  }
}
</script>

<style>
/* Styles just to make the bars for X Y and Z look neat */
.bar {
  width : 500px;
  height: 24px;
  background-color : #D0D0D0;
  position:relative;
  display: inline-block;
}
.bar span {
  width : 1px;
  height: 20px;
  background-color : red;
  position:absolute;
  display: inline-block;
  left: 150px;
  top: 2px;
}
</style>

 </body>
</html>
