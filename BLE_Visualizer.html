<html>
 <head>
  <title>Bangle.js BLE Sensor Visualizer</title>
 </head>
 <body>

<button id="btnConnect">Connect via BLE</button>
<h3>Accelerometer</h3>
<p>X: <span class="bar"><span id="barAccelX"></span></span> <span id="valueAccelX">0</span></p>
<p>Y: <span class="bar"><span id="barAccelY"></span></span> <span id="valueAccelY">0</span></p>
<p>Z: <span class="bar"><span id="barAccelZ"></span></span> <span id="valueAccelZ">0</span></p>

<h3>Magnetometer</h3>
<p>X: <span class="bar"><span id="barMagX"></span></span> <span id="valueMagX">0</span></p>
<p>Y: <span class="bar"><span id="barMagY"></span></span> <span id="valueMagY">0</span></p>
<p>Z: <span class="bar"><span id="barMagZ"></span></span> <span id="valueMagZ">0</span></p>

<p><strong>Data Rate: <span id="dataRate">0</span> Hz</strong></p>

<script>
var accelChar, magChar;
var messagesThisSecond = 0;
var dataRateTimer;

document.getElementById("btnConnect").addEventListener("click", connectBLE);

async function connectBLE() {
  if (!('bluetooth' in navigator)) {
    alert('Web Bluetooth is not supported in this browser. Please use Chrome or Edge.');
    return;
  }
  
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['f8b23a4d-89ad-4220-8c9f-d81756009f0c']
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('f8b23a4d-89ad-4220-8c9f-d81756009f0c');
    
    accelChar = await service.getCharacteristic('f8b23a4d-89ad-4220-8c9f-d81756009f0d');
    magChar = await service.getCharacteristic('f8b23a4d-89ad-4220-8c9f-d81756009f0c');
    
    await accelChar.startNotifications();
    await magChar.startNotifications();
    
    accelChar.addEventListener('characteristicvaluechanged', handleAccel);
    magChar.addEventListener('characteristicvaluechanged', handleMag);
    
    dataRateTimer = setInterval(() => {
      document.getElementById("dataRate").textContent = messagesThisSecond;
      messagesThisSecond = 0;
    }, 1000);
    
    console.log("Connected via BLE");
    alert("Connected successfully!");
  } catch (error) {
    console.error('BLE connection failed:', error);
    alert('BLE connection failed: ' + error.message);
  }
}

function handleAccel(event) {
  const data = new Float32Array(event.target.value.buffer);
  const accel = { x: data[0], y: data[1], z: data[2] };
  
  setBarPos("barAccelX", accel.x, 2);
  setBarPos("barAccelY", accel.y, 2);
  setBarPos("barAccelZ", accel.z, 2);
  
  document.getElementById("valueAccelX").textContent = accel.x.toFixed(2);
  document.getElementById("valueAccelY").textContent = accel.y.toFixed(2);
  document.getElementById("valueAccelZ").textContent = accel.z.toFixed(2);
  
  messagesThisSecond++;
}

function handleMag(event) {
  const data = new Int32Array(event.target.value.buffer);
  const mag = { x: data[0], y: data[1], z: data[2] };
  
  setBarPos("barMagX", mag.x, 10000);
  setBarPos("barMagY", mag.y, 10000);
  setBarPos("barMagZ", mag.z, 10000);
  
  document.getElementById("valueMagX").textContent = mag.x;
  document.getElementById("valueMagY").textContent = mag.y;
  document.getElementById("valueMagZ").textContent = mag.z;
  
  messagesThisSecond++;
}

function setBarPos(id, d, scale) {
  var s = document.getElementById(id).style;
  var scaledValue = (d / scale) * 150;
  
  if (scaledValue > 150) scaledValue = 150;
  if (scaledValue < -150) scaledValue = -150;
  
  if (scaledValue >= 0) {
    s.left = "150px";
    s.width = scaledValue + "px";
  } else {
    s.left = (150 + scaledValue) + "px";
    s.width = (-scaledValue) + "px";
  }
}
</script>

<style>
.bar {
  width: 500px;
  height: 24px;
  background-color: #D0D0D0;
  position: relative;
  display: inline-block;
}
.bar span {
  width: 1px;
  height: 20px;
  background-color: red;
  position: absolute;
  display: inline-block;
  left: 150px;
  top: 2px;
}
</style>

 </body>
</html>
